#!/bin/bash

# Merges the sql scripts sorted according to version number
# of all folders and subfolders starting from a given dir. 
# Outputs a 'merged.sql' file. Bash 4+ is required and also 
# the globstar option to be set.

# Usage:
# create a new-folder and copy there
# all folders containing sql files
# cd to new-folder and run 'gluesql'
# alternatively from anywhere run 
# gluesql new-folder

shopt -s globstar

currentdir="$*"
cd "$currentdir" || exit 1

mapfile -d '' files < <(printf '%s\0' **/*.sql | sort -zV)
for file in "${files[@]}"; do
    printf '\n\n%s\n%s\n%s\n\n' \
        "-- ================" \
        "-- ${file##*/} --" \
        "-- ================" >> merged.sql 
    while IFS= read -r line || [[ -n "$line" ]]; do
            printf '%s\n' "$line" >> merged.sql
    done < "$file"
done
